import { throttle, exec } from 'utils';
import type { ReceiverData } from 'types';
import { REHABEAM_RECEIVER_URL } from 'constants';

/**
 * @description Send data to the receiver.
 */
export const sendDataToReceiver = throttle(({ context, message = '', text = '', json = '' }: ReceiverData, cb?: () => void): Promise<
	void
> => {
	if (!message && !text && !json) {
		return;
	}

	const formData = new FormData();

	formData.append('context', context);
	formData.append('message', message);
	formData.append('text', text);
	formData.append('json', json);

	exec(() =>
		fetch(REHABEAM_RECEIVER_URL, {
			method: 'POST',
			body: formData,
		})
	).then(() => cb?.());

	/**
	 * Even if the page is terminated, fetch is still sent but not intercepted.
	 */
	return Promise.resolve();
}, 5);
